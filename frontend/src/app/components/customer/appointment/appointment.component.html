<div class="appointment-container">
  <!-- Header Section -->
  <div class="appointment-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <i class="fas fa-calendar-check"></i>
          Book Your Appointment
        </h1>
        <p class="page-subtitle">Schedule your car wash service with ease</p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="appointment-content">
    <div class="form-container">
      <div class="form-header">
        <h2>Service Details</h2>
        <p>Fill in the details below to book your car wash appointment</p>
      </div>

      <form
        class="booking-form"
        (ngSubmit)="submitBooking()"
        autocomplete="off"
      >
        <!-- Vehicle and Service Selection -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-car"></i>
            <span>Vehicle & Service</span>
          </div>

          <!-- Saved Vehicles and Services (Side by Side) -->
          <div class="form-row" *ngIf="customerVehicles.length > 0">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Select from Saved Vehicles*</mat-label>
              <mat-select
                [(ngModel)]="selectedVehicleId"
                name="savedVehicle"
                required
                (selectionChange)="onSavedVehicleSelect($event.value)"
              >
                <mat-option
                  *ngFor="let vehicle of customerVehicles"
                  [value]="vehicle.id"
                >
                  <div class="vehicle-option">
                    <span class="vehicle-name">{{
                      vehicle.nickname || vehicle.vehicle_model
                    }}</span>
                    <span class="vehicle-details"
                      >{{ vehicle.vehicle_type }} • {{ vehicle.plate_number }} •
                      {{ vehicle.vehicle_model }}</span
                    >
                  </div>
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>bookmark</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Select Services*</mat-label>
              <mat-select
                [(ngModel)]="bookingForm.services"
                name="services"
                required
                (selectionChange)="onServiceChange()"
              >
                <mat-option
                  *ngFor="let service of servicePackages"
                  [value]="service"
                >
                  <div class="service-option">
                    <span class="service-name">{{ service }}</span>
                  </div>
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="selected-vehicle-highlight" *ngIf="selectedVehicle">
            <div class="selected-vehicle-primary">
              <span class="selected-vehicle-name">
                {{
                  selectedVehicle.nickname ||
                    selectedVehicle.vehicle_model ||
                    selectedVehicle.vehicleModel
                }}
              </span>
              <span class="selected-vehicle-plate">
                {{
                  selectedVehicle.plate_number ||
                    selectedVehicle.plateNumber ||
                    selectedVehicle.plate
                }}
              </span>
            </div>
            <div class="selected-vehicle-meta">
              <span class="selected-vehicle-type">
                {{
                  getVehicleTypeLabel(
                    selectedVehicle.vehicle_type || selectedVehicle.vehicleType
                  )
                }}
              </span>
              <span
                class="selected-vehicle-model"
                *ngIf="
                  selectedVehicle.vehicle_model || selectedVehicle.vehicleModel
                "
              >
                {{
                  selectedVehicle.vehicle_model || selectedVehicle.vehicleModel
                }}
              </span>
            </div>
          </div>

          <!-- Message if no saved vehicles -->
          <div class="form-row" *ngIf="customerVehicles.length === 0">
            <div class="no-vehicles-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>
                You need to add a vehicle to your profile before booking. Please
                go to your profile to add a vehicle first.
              </p>
            </div>
          </div>

          <!-- Price Display -->
          <div class="price-display" *ngIf="selectedPrice">
            <div class="price-card">
              <div class="price-header">
                <i class="fas fa-tag"></i>
                <span>Calculated Price</span>
              </div>
              <div class="price-amount">₱{{ selectedPrice }}</div>
            </div>
          </div>

          <!-- Unavailable Display -->
          <div
            class="price-display"
            *ngIf="!selectedPrice && isUnavailableSelection"
          >
            <div class="price-card unavailable">
              <div class="price-header">
                <i class="fas fa-ban"></i>
                <span>Not Available</span>
              </div>
              <div class="price-amount">
                This combination is currently inactive
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule</span>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Wash Date*</mat-label>
              <input
                matInput
                [matDatepicker]="picker"
                [(ngModel)]="bookingForm.washDate"
                name="washDate"
                required
                placeholder="Select wash date"
                [min]="minDate"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Wash Time*</mat-label>
              <input
                matInput
                type="time"
                [(ngModel)]="bookingForm.washTime"
                name="washTime"
                required
                placeholder="Select wash time"
                class="time-input-field"
                [min]="effectiveMinTime()"
                [max]="'20:00'"
                (ngModelChange)="onTimeInputChange($event)"
              />
              <mat-icon
                matSuffix
                class="time-picker-icon"
                (click)="openTimePicker()"
                >schedule</mat-icon
              >

              <!-- Time Picker Overlay -->
              <div
                class="time-picker-overlay"
                *ngIf="showTimePicker"
                (click)="closeTimePicker($event)"
              >
                <div
                  class="time-picker-panel"
                  (click)="$event.stopPropagation()"
                >
                  <div class="time-picker-header">
                    <h3>Select Time</h3>
                    <button
                      class="close-btn"
                      type="button"
                      title="Close time picker"
                      aria-label="Close time picker"
                      (click)="closeTimePicker($event)"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <!-- Three Column Time Picker -->
                  <!-- Availability Note -->
                  <div class="time-availability-note">
                    Available time: 8:00 AM – 8:00 PM
                  </div>

                  <div class="time-picker-columns">
                    <!-- Hours Column -->
                    <div class="time-column">
                      <div class="column-header">Hour</div>
                      <div class="column-content" #hoursContainer>
                        <div
                          *ngFor="let hour of availableHours"
                          class="time-option"
                          [class.disabled]="
                            isHourDisabledForCurrentPeriod(hour)
                          "
                          [class.selected]="selectedHour === hour"
                          (click)="selectHour(hour)"
                        >
                          {{ hour }}
                        </div>
                      </div>
                    </div>

                    <!-- Minutes Column -->
                    <div class="time-column">
                      <div class="column-header">Minute</div>
                      <div class="column-content" #minutesContainer>
                        <div
                          *ngFor="let minute of availableMinutes"
                          class="time-option"
                          [class.selected]="selectedMinute === minute"
                          (click)="selectMinute(minute)"
                        >
                          {{ minute }}
                        </div>
                      </div>
                    </div>

                    <!-- AM/PM Column -->
                    <div class="time-column">
                      <div class="column-header">Period</div>
                      <div class="column-content" #periodContainer>
                        <div
                          *ngFor="let minute of availablePeriods"
                          class="time-option"
                          [class.selected]="selectedPeriod === minute"
                          (click)="selectPeriod(minute)"
                        >
                          {{ minute }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="time-picker-actions">
                    <button
                      class="btn-cancel"
                      (click)="closeTimePicker($event)"
                      type="button"
                    >
                      Cancel
                    </button>
                    <button
                      class="btn-confirm"
                      (click)="confirmTimeSelection()"
                      type="button"
                    >
                      Done
                    </button>
                  </div>
                </div>
              </div>
            </mat-form-field>
          </div>
        </div>

        <!-- Payment -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-credit-card"></i>
            <span>Payment</span>
          </div>

          <div class="form-row">
            <mat-form-field
              appearance="outline"
              class="form-field payment-type-field"
            >
              <mat-label>Payment Type*</mat-label>
              <mat-select
                [(ngModel)]="bookingForm.paymentType"
                name="paymentType"
                required
                (selectionChange)="onPaymentTypeChange()"
              >
                <mat-option *ngFor="let type of paymentTypes" [value]="type">
                  <i class="fas fa-credit-card"></i> {{ type }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Online Payment Sub-options -->
          <div
            class="form-row online-payment-options"
            *ngIf="bookingForm.paymentType === 'Online Payment'"
          >
            <div class="online-payment-header">
              <i class="fas fa-mobile-alt"></i>
              <span>Select Payment Method</span>
            </div>
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Payment Method*</mat-label>
              <mat-select
                [(ngModel)]="bookingForm.onlinePaymentOption"
                name="onlinePaymentOption"
                required
              >
                <mat-option
                  *ngFor="let option of onlinePaymentOptions"
                  [value]="option"
                >
                  <i class="fas fa-mobile-alt"></i> {{ option }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <!-- Additional Notes -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-sticky-note"></i>
            <span>Additional Information</span>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes</mat-label>
            <textarea
              matInput
              [(ngModel)]="bookingForm.notes"
              name="notes"
              rows="10"
              placeholder="Any special instructions or additional notes..."
              class="notes-textarea"
            ></textarea>
          </mat-form-field>
        </div>

        <!-- Messages -->
        <div class="messages-container" *ngIf="errorMessage || successMessage">
          <div class="message error-message" *ngIf="errorMessage">
            <i class="fas fa-exclamation-circle"></i>
            {{ errorMessage }}
          </div>
          <div class="message success-message" *ngIf="successMessage">
            <i class="fas fa-check-circle"></i>
            {{ successMessage }}
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="isSubmitting"
            class="submit-button"
          >
            <i class="fas fa-calendar-plus" *ngIf="!isSubmitting"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isSubmitting"></i>
            {{ isSubmitting ? "Booking..." : "Book Appointment" }}
          </button>
        </div>
      </form>
    </div>

    <!-- Sidebar with Tips -->
    <div class="appointment-sidebar">
      <!-- Pricing Guide -->
      <div class="sidebar-card pricing-guide">
        <div class="card-header">
          <i class="fas fa-calculator"></i>
          <h3>PRICING GUIDE</h3>
        </div>
        <div class="card-content">
          <!-- Step 1: Vehicle Types -->
          <div class="pricing-step">
            <h4>Step 1: Identify Vehicle Type</h4>
            <div class="vehicle-types-list">
              <div class="vehicle-type-item">
                <span class="vehicle-code">S:</span>
                <span class="vehicle-desc">Sedans (all sedan types)</span>
              </div>
              <div class="vehicle-type-item">
                <span class="vehicle-code">M:</span>
                <span class="vehicle-desc">SUVs (all SUV types)</span>
              </div>
              <div class="vehicle-type-item">
                <span class="vehicle-code">L:</span>
                <span class="vehicle-desc">VANs (any type of van)</span>
                >
              </div>
              <div class="vehicle-type-item">
                <span class="vehicle-code">XL:</span>
                <span class="vehicle-desc"
                  >Larger than vans (big SUVs/pickups, oversized vehicles)</span
                >
              </div>
            </div>
          </div>

          <!-- Step 2: Service Packages -->
          <div class="pricing-step">
            <h4>Step 2: Select Services</h4>
            <div class="service-packages-list">
              <div class="service-package-item">
                <span class="service-code">1:</span>
                <span class="service-desc">Body Wash</span>
              </div>
              <div class="service-package-item">
                <span class="service-code">2:</span>
                <span class="service-desc">Wash / Vacuum</span>
              </div>
              <div class="service-package-item">
                <span class="service-code">3:</span>
                <span class="service-desc">Wash / Vacuum / Hand Wax</span>
              </div>
              <div class="service-package-item">
                <span class="service-code">4:</span>
                <span class="service-desc">Wash / Vacuum / Buffing Wax</span>
              </div>
            </div>
          </div>

          <!-- Step 3: Pricing Table -->
          <div class="pricing-step">
            <h4>Step 3: Determine Price</h4>
            <div class="pricing-table">
              <div class="pricing-header">
                <div class="header-cell">Vehicle</div>
                <div
                  class="header-cell"
                  *ngFor="let serviceCode of serviceCodes"
                >
                  {{ serviceCode.replace("p", "") }}
                </div>
              </div>
              <div
                class="pricing-row"
                *ngFor="let vehicleCode of vehicleTypeCodes"
              >
                <div class="vehicle-cell">{{ vehicleCode }}</div>
                <div
                  class="price-cell"
                  *ngFor="let serviceCode of serviceCodes"
                >
                  {{ formatPrice(vehicleCode, serviceCode) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="card-header">
          <i class="fas fa-lightbulb"></i>
          <h3>Booking Tips</h3>
        </div>
        <div class="card-content">
          <ul class="tips-list">
            <li>
              <i class="fas fa-clock"></i>
              <span>Book at least 30 Minutes in advance</span>
            </li>
            <li>
              <i class="fas fa-car"></i>
              <span>Ensure your vehicle is accessible</span>
            </li>
            <li>
              <i class="fas fa-phone"></i>
              <span>Keep your phone nearby for updates</span>
            </li>
            <li>
              <i class="fas fa-credit-card"></i>
              <span>Payment is processed after service completion</span>
            </li>
          </ul>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h3>Service Hours</h3>
        </div>
        <div class="card-content">
          <div class="hours-info">
            <div class="hours-row">
              <span class="day">Monday - Sunday</span>
              <span class="time">8:00 AM - 8:00 PM</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
